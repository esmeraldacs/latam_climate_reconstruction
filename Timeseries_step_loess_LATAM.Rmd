---
title: "Nuevo plot"
output: html_document
date: "2022-10-14"
---

```{r}
`%$%` <- magrittr::`%$%`
library(tidyverse)
#library(sf)
```


```{r}
sam_raster <- raster::raster("Output_data/summer_precip_latam.tif") %>%
  raster::rasterToPoints() %>%
  as.data.frame(stringsAsFactors = FALSE) %>%
  rename(lon = x, lat = y, precip_percentage = summer_precip_latam)

ggplot() +
  geom_raster(data = sam_raster, aes(x = lon, y = lat, fill = precip_percentage)) +
  scico::scale_fill_scico(palette = 'lapaz',direction = -1) +
  coord_fixed() +
  theme_test()
```


```{r}
land_polyg <- rgdal::readOGR("C:/Users/esmer/UoR/Paper two/Maps_paper_two_August_2022/Natural_earth_data/Land_polygon_large_ne_10m_land/ne_10m_land.shp", layer=rgdal::ogrListLayers("C:/Users/esmer/UoR/Paper two/Maps_paper_two_August_2022/Natural_earth_data/Land_polygon_large_ne_10m_land/ne_10m_land.shp")) |>
    sp::spTransform("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 +units=m +no_defs") |> 
    raster::crop(raster::extent(-118,-35,-60,32)) |>
    sf::st_as_sf()
```


Input files
```{r}
latam <- read.csv("C:/Users/esmer/UoR/latinam_climate/Output_train_amg/Train_amg_reconstruction_output_Hill_15.2.csv") |>
  filter(entity!="Laguna Cerritos") |>
  filter(!entity  %in% c("Cenote Kail","Lago Hui��aimarca - Lake Titi")) |>
  filter(elvation > -100) |>
  mutate(entity = paste0(entity,"_",latitude,"_",longitude,"_",elvation)) |>
  filter(age <= 11600)


ggplot() +
  geom_sf(data=land_polyg, fill="transparent", color="black") +
  scale_y_continuous(expand = c(0,0)) +
  geom_point(data=latam, aes(x=longitude, y=latitude), colour="#0084ff") +
  labs(subtitle = "all f")+
  theme_test()
  
```

Calculate resolution of the records
```{r}
latam %>%
  arrange(entity,age) |>
  group_by(entity) %>%
  mutate(
    anterior = lag(age),
    reso = age - anterior,
    resolucion = mean(reso, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  summarise(mean_resol = mean(resolucion, na.rm = TRUE))
```



```{r}
map1 <- ggplot() +
  geom_raster(data = sam_raster, aes(x = lon, y = lat, fill = precip_percentage)) +
  scico::scale_fill_scico(palette = 'lapaz',direction = -1) +
  geom_point(data = latam, aes(x=longitude,y=latitude), shape=21) +
  coord_equal() +
  labs(title = "Percentage of Dec/Jan/Feb Precipitation",
       x = "Longitude",
       y = "Latitude",
       fill = "Precipitation (%)") +
  theme_test()

map1
```


```{r}
#ggsave(plot=map1, "plot_groups/grouping_map_c.png",units = "cm", width = 10, height = 12)
```



Renaming variables
```{r}
clim0 <- latam |>
  dplyr::select(-c(X, id_sample,depth)) |>
  rename(elevation = elvation,
         mtco = mtco_pred,
         alpha = alpha_pred,
         mtwa = mtwa_pred,
         gdd = gdd_pred,
         alpha_sse = alpha_see,
         mtwa_sse = mtwa_see) 

clim0
```


Filter samples with a Hill diversity number higher or equal to 2
```{r}
clim0 <- clim0 |>
  filter(hill_n2 >= 2) |>
  dplyr::select(-hill_n2) |>
  arrange(entity,age)

site_metadadata <- clim0 |> dplyr::select(entity,latitude,longitude,elevation) |> distinct()
```


Reshaping the dataframe in preparation to filter outliers
```{r}
clim0 <- clim0 |> mutate(ID = paste0("ID_",row_number()))

clim0

clim0_pred <- clim0 |>
  pivot_longer(cols = !c(ID,entity,latitude,longitude,elevation,age), names_to = "variable") |>
  filter(variable%in%c("mtco","gdd","alpha","mtwa"))

clim0_sse <- clim0 |>
  pivot_longer(cols = !c(ID,entity,latitude,longitude,elevation,age),names_to = "variable") |>
  filter(variable%in%c("mtco_sse","gdd_sse","alpha_sse","mtwa_sse"))
```


A function to find ouliers in estandar deviations
```{r}
find_outlier <- function(x) {
  return(x < quantile(x, .5) - 1.5*IQR(x) | x > quantile(x, .95) + 1.5*IQR(x))
}
```


Remove samples that are outliers
```{r}
#add new column to data frame that indicates if each observation is an outlier
outliers_tag <- clim0_sse |>
  group_by(variable) |>
  mutate(sse_outlier = ifelse(find_outlier(value), value, NA)) |>
  ungroup() |>
  filter(is.na(sse_outlier)) |>
  mutate(variable = str_replace(variable,"_sse","")) |>
  dplyr::select(-c(sse_outlier,value))

clim <- outliers_tag |>
  inner_join(clim0_pred, by=c("ID","entity","latitude","longitude","elevation","age","variable")) #|>
  #select(-ID)
  
clim
```


Filter entities with modern age
```{r}
with_modern_age <- clim |>
  group_by(variable, entity) |>
  mutate(age_min = case_when(age <= 350 ~ T)) |>
  ungroup() |>
  filter(age_min == T) |>
  dplyr::select(entity) |>
  distinct() |>
  pull()

pollens <- clim |> filter(entity%in%with_modern_age) |>
  pivot_wider(names_from = variable, values_from = value) |>
  arrange(entity,age)

latitude_position <- clim |>
  filter(entity%in%with_modern_age) |>
  dplyr::select(entity,latitude) |>
  dplyr::distinct() |>
  arrange(desc(latitude)) |>
  mutate(lat_position = row_number())
```




Correct alpha

```{r}
#Obtain modern CO2 from (Bereiter et al. 2015)
modern_co2 <- tibble::tibble(age = 1950 - c(1961:1990),
                             co2_init = purrr::map_dbl(age, codos::past_co2)) |>
  dplyr::mutate(co2 =  median(co2_init)) |>
  dplyr::select(co2) |> dplyr::distinct() |> dplyr::pull()

embs0 <- pollens |> mutate(modern_co2 = modern_co2)
```



```{r}
#Obtain past CO2 values
entidades <- unique(embs0$entity)
embs1 <- data.frame()
  for (i in entidades){
    aux1 <- embs0 %>% 
        filter(entity == i) %$%
        purrr::map_dbl(age, codos::past_co2)
    
    aux2 <- embs0 %>% 
      filter(entity == i) |>
      mutate(paleo_co2 = aux1)
               
    embs1 <- bind_rows (embs1, aux2)
  }
```



```{r}
#Estimate past Tmean values
embs2 <- embs1 |> dplyr::mutate(id=row_number())

muestras <- unique(embs2$id)
embs3 <- data.frame()
  for (i in muestras){
    aux1 <- embs2 |> filter(id == i) 
    aux2 <- with(aux1, codos::int_sin(mtco, mtwa))
    aux3 <- aux2[aux2 > 0] # Filter remperatures above 0°C
    aux4 <- aux1 |> mutate(palaeo_MGS_temp = mean(aux3))
    embs3 <- bind_rows (embs3, aux4)
  }
```


Example plot
```{r}
a <- codos::int_sin(-12.10125354, 15.25460) #15.2540934 	
#15.254093

as_tibble(a) |>
  mutate(day=c(365:1)) |>
  filter(value > 0) |>
  mutate(mean_gdd = mean(value))

b <- as_tibble(a) |>
  mutate(day=c(365:1))
 
plot_mgs <- b |> 
  ggplot(aes(x=day,y=value))+
  geom_line() +
  geom_hline(yintercept = 9.629978, linetype="dashed",size=0.65) +
  geom_hline(yintercept = -12.10125354, colour="#fb607f",size=0.65) +
  geom_hline(yintercept = 15.25460,colour="#1974D2",size=0.65) +
  annotate("text", x = 60, y = ((-12.10125354)+0.8), label = "MTCO",colour="#fb607f",size=3) +
  annotate("text", x = 60, y = ((15.25460)+0.8), label = "MTWA",colour="#1974D2",size=3) +
  annotate("text", x = 60, y = ((9.629978)+0.8), label = "MGS (mean growing season)",size=3) +
  labs(x="Days", y="Temperature (°C)",subtitle = "Site: Kismohos\nAge: 12.148 ky") +
  scale_y_continuous(n.breaks = 10) +
  theme(plot.subtitle = element_text(size=8),
        axis.title = element_text(size=8),
        axis.text = element_text(size=8),
        #axis.title = element_blank(),
        #axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(color="transparent",fill = "transparent"),
        panel.border = element_rect(colour="black",fill="transparent"))

plot_mgs
```

```{r}
#ggsave(plot_mgs, filename = "Output_reconstruction_amg_resubmitt/MGS_sin_example.png",units = "cm",width = 12,height = 8.5)
```



Add modern MGS temperature obtained by averaging the youngest 300 years
```{r}
embs4 <- embs3 |>
  group_by(entity) |>
  mutate(aux1 = case_when(age <= 350  ~ palaeo_MGS_temp)) |> #case_when(age <= min(age)+300  ~ value))
  mutate(modern_MGS_temp = case_when(!is.na(aux1) ~ mean(aux1, na.rm = T))) |>
  tidyr::fill(modern_MGS_temp, .direction = "updown") |>
  ungroup() |>
  dplyr::select(-aux1)
```


Plot of Kismohos
```{r}
embs4 |>
  filter(entity=="Lake Pet��n-I_16.96397_-89.84187_110") |>
  filter(age <= 12300) |>
  pivot_longer(cols = !c(entity,latitude,longitude,elevation,age,ID,id)) |>
  filter(name%in%c("mtco","mtwa","palaeo_MGS_temp")) |>  
  ggplot() +
  geom_line(aes(x=age,y=value, group=name,colour=name)) +
  scale_colour_manual(values=c("mtco"="dodgerblue","mtwa"="firebrick","palaeo_MGS_temp"="mediumseagreen")) +
  #geom_point(data=punto,aes(x=0, y=7.64817),size=4,colour="red") +
  labs(title = "Lake Peten-I")+
  theme_test()
```


Correction of alpha
```{r}
embs5 <- embs4 |>
  dplyr::select(entity,latitude,longitude,elevation,age,modern_MGS_temp,palaeo_MGS_temp,alpha,modern_co2,paleo_co2,ID,id) |>
  drop_na() |>
  mutate(alpha_pred_corr = codos::corrected_mi(Tc0 = modern_MGS_temp,
                                       Tc1 = palaeo_MGS_temp,
                                        MI = alpha,
                                          ca0= modern_co2,
                                          ca1 = paleo_co2))
```



Example plot
```{r}
embs5 |>
  filter(entity=="Lake Pet��n-I_16.96397_-89.84187_110") |>
  filter(age <= 13300) |>
  pivot_longer(cols = !c(entity,latitude,longitude,elevation,age,ID,id)) |>
  filter(name%in%c("alpha","alpha_pred_corr")) |>  
  mutate(name=case_when(name=="alpha_pred_corr" ~ "alpha corrected",
                        name == "alpha" ~ "alpha predicted")) |>
  ggplot() +
  geom_line(aes(x=age,y=value, group=name,colour=name)) +
  scale_colour_manual(values=c("alpha predicted"="dodgerblue","alpha corrected"="firebrick")) +
 # geom_point(data=punto,aes(x=0, y=7.64817),size=4,colour="red") +
  scale_x_continuous(breaks = seq(0, 13300, by = 1000), labels= seq(0,13.3, by=1)) +
  labs(title = "Petén-I", y= "alpha", x= "age (ky)")+
  theme_test()
```




```{r}
alpha <- embs5 |> 
  dplyr::select(entity,latitude,longitude,age,ID,alpha,alpha_pred_corr)


pollens1 <- pollens |>
  full_join(alpha,by=c("entity","latitude","longitude","age","ID","alpha"))


pollens1 <- pollens1 |>
  pivot_longer(cols = !c(entity,latitude,longitude,elevation,age,ID),names_to = "variable") |>
  filter(!is.na(value)) |>
  dplyr::select(-ID)

pollens1
```



```{r}
value_anomaly <- pollens1 |>
  group_by(variable,entity) |>
  mutate(aux1 = case_when(age <= 350  ~ value)) |> #case_when(age <= min(age)+300  ~ value))
  mutate(modern_value = case_when(!is.na(aux1) ~ mean(aux1, na.rm = T))) |>
  tidyr::fill(modern_value, .direction = "updown") |>
  ungroup() |>
  mutate(value_anomaly = value - modern_value) |>
  dplyr::select(variable,entity,age,value,modern_value,value_anomaly)

#write.csv(with_modern_age, "Output/sites_with_modern_samples_to_get_anomaly.csv")
```


```{r}
aux5 <- latam |>
  filter(entity %in% unique(value_anomaly$entity)) |>
  group_by(entity) |>
#  add_tally(name = "sampls_per_entity") |>
  mutate(lenght = max(age)-min(age)) |>
  ungroup() |>
 # filter(lenght > 150,
        # sampls_per_entity > 2) |>
  mutate(lenght_ky = lenght/1000) 


aux5 <- aux5 |>
  dplyr::select(entity,latitude,longitude,lenght_ky) |>
  distinct()


plot0 <- ggplot() +
  geom_sf(data=land_polyg, fill="transparent", color="gray50") +
  scale_y_continuous(expand = c(0,0)) +
  geom_point(data=aux5, aes(x=longitude, y=latitude, fill = lenght_ky),,size=1.5,shape=21,linetype=3,stroke=0.3) +
  labs(subtitle = "Fossil entities in latam",x=NULL,y=NULL,fill="Length\n(ka)")+
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) +
#  scale_fill_stepsn(colours = c("#ff6666","#ff9966","#ffcc66","#669999","#33cccc"),n.breaks=7)+
  scale_fill_stepsn(colours = c("#ff6666","#ffcc66","#e7fc67","#33c0a4","#008080"),n.breaks=6)+
   theme(panel.background = element_rect(fill="white",color="transparent"),
        panel.border = element_rect(fill="transparent",color="black"),
        panel.grid = element_blank(),
        axis.title.x = element_text(size=7.5,color = "black"),
        axis.title.y = element_text(size=7.5, angle=90),
        axis.text.x = element_text(size=7.5),
        axis.text.y = element_text(size=7.5),
       # axis.ticks = element_blank(),
        plot.subtitle = element_text(size=9),
        legend.key.size = unit(0.28,"cm"),
        legend.text.align = 0,
        legend.text=element_text(size=7.5),
        legend.title.align = 0.5,
        legend.title = element_text(size = 7.5),
        legend.margin = margin(unit = "cm", t=0.05,r=0.08,b=0.05,l=0.08),
        legend.box.background = element_rect(fill=alpha('white', 0.2),color="gray30",size = 0.15,),
        legend.background = element_rect(fill=alpha('white', 0.45),color="gray30",size = 0.25),
        legend.position = c(0.15,0.25))

plot0
```

```{r}
ggsave(plot = plot0, filename = "Output_figures/map_of_with_modern_anomaly_sites.png",units = "cm", width = 8,height = 10)
```


#Produce windows
```{r}
bin_width <- 300 # To ajust accordingly to the mean resolution of the records
overlap <- 0.5  # 50% overlap
age_min <- -bin_width/2
age_max <- 12000

biome_bin <- data.frame()
for (i in seq(age_min + bin_width/2, age_max, bin_width * (1 - overlap))) {
  
  bin_start <- i - bin_width / 2 
  bin_end <- i + bin_width / 2
  
  aux1 <- value_anomaly %>%
    filter(age >= bin_start & age < bin_end) %>% # Filter rows within the current bin
    mutate(bincentre = i)

  biome_bin <- bind_rows(biome_bin, aux1)
}
```



```{r}
allmodels_binn <- biome_bin |>
  group_by(variable, entity, bincentre) |>
  add_tally(name = "sampls_x_bin") |>
  filter(sampls_x_bin >= 2) |> #Filter windows with a minimum of two samples each.
  mutate(anomaly_bin =  mean(value_anomaly)) |>
  ungroup() |>
  dplyr::select(variable,entity,bincentre,anomaly_bin) |>
  distinct() 


allmodels_mean <- allmodels_binn |>
  group_by(variable,bincentre) |>
  mutate(anomaly_mean = mean(anomaly_bin)) |>
  ungroup() |>
  dplyr::select(variable,bincentre,anomaly_mean) |>
  distinct()


allmodels_binn |> 
  ggplot(aes(x=bincentre,y=anomaly_bin,group=entity,colour=variable)) +
  geom_step(alpha=1,show.legend = F) +
  facet_wrap(~variable, scales="free_y")


allmodels_mean |>
  ggplot(aes(x=bincentre, y=anomaly_mean,colour=variable))+
  geom_step() +
  facet_wrap(~variable, scales="free_y")
```



```{r}
allmodels_binn0 <- allmodels_binn |>
  inner_join(site_metadadata,by = c("entity"))
  
aux_lat <- allmodels_binn0 |>
  inner_join(latitude_position,by = c("entity", "latitude")) |>
  dplyr::select(entity, latitude, lat_position) |>
  distinct() |>
  arrange(lat_position) |>
  mutate(lat_position = row_number())
  
todos <- allmodels_binn0 |>
  inner_join(aux_lat,by = c("entity", "latitude")) |>
  group_by(variable) |>
  arrange(desc(lat_position)) |>
  ungroup() |>
  mutate(lat_position = fct_inorder(factor(lat_position, ordered = TRUE)))


allmodels_mean <- todos |>
  group_by(variable,bincentre) |>
  mutate(anomaly_mean = mean(anomaly_bin)) |>
  ungroup() |>
  dplyr::select(variable,bincentre,anomaly_mean) |>
  distinct()


allmodels_mean |>
  ggplot(aes(x=bincentre, y=anomaly_mean,colour=variable))+
  geom_step() +
  facet_wrap(~variable, scales="free_y")
```


```{r}
saveRDS(object = allmodels_mean, "plot_groups/3_zones_c_allmodels_mean.rds")
```



```{r}
single_mean <- allmodels_binn0 |>
  group_by(variable,bincentre) |>
  mutate(anomaly_mean = mean(anomaly_bin)) |>
  ungroup() |>
  dplyr::select(variable,bincentre,anomaly_mean) |>
  distinct()

single_mean$anomaly_mean_log <- log(abs(single_mean$anomaly_mean) + 1)

single_mean$anomaly_mean_squared <- single_mean$anomaly_mean^2

single_mean |>
  ggplot(aes(x=bincentre, y=anomaly_mean,colour=variable))+
  geom_step(show.legend = F) +
  facet_wrap(~variable, scales="free_y") +
  labs(subtitle = "window 350 regular scale")

single_mean |>
  ggplot(aes(x=bincentre, y=anomaly_mean_log,colour=variable))+
  geom_step(show.legend = F) +
  facet_wrap(~variable, scales="free_y") +
  labs(subtitle = "window 350 log scale")

single_mean |>
  ggplot(aes(x=bincentre, y=anomaly_mean_squared,colour=variable))+
  geom_step(show.legend = F) +
  facet_wrap(~variable, scales="free_y") +
  labs(subtitle = "window 350 squared scale")
```


```{r}
saveRDS(object = allmodels_mean, "plot_groups/3_zones_c_single_mean.rds")
```




Para una sola serie de tiempo
```{r}
library(locfit)
hw <- 500
n_repeat <- 1000

v_variable <- unique(allmodels_binn$variable)

single_envelope <- data.frame()

for (j in v_variable) {
    
    aux2 <- allmodels_binn %>%
      filter(variable == j) %>%
      dplyr::select(entity, bincentre, anomaly_bin)
    
    aux_matrix <- aux2 %>%
      arrange(entity, bincentre) %>%
      tidyr::pivot_wider(id_cols = bincentre, names_from = entity, values_from = anomaly_bin) %>%
      arrange(bincentre) %>%
      dplyr::select(-bincentre) %>%
      as.matrix()
    
    centres <- unique(aux2$bincentre)
    
    # Bootstrapping
    aux_boot <- matrix(nrow = length(centres), ncol = n_repeat)
    set.seed(3654)
    for (k in 1:n_repeat) {
      ne <- sample(seq(1, ncol(aux_matrix), 1), ncol(aux_matrix), replace = TRUE) # randomly sample columns (cols = sites)
      y <- as.vector(as.matrix(aux_matrix)[, ne])
      x <- as.vector(rep(centres, length(ne)))
      
      locboot <- locfit(y ~ lp(x, deg = 1, h = hw), maxk = 2000, family = "grgauss")
      aux_predict <- predict(locboot, newdata = centres, se.fit = TRUE) # loess smoothed fit through randomly sampled data
      aux_boot[, k] <- aux_predict$fit # save output
    }
    
    # Confidence intervals from bootstrapping
    envelope <- t(apply(aux_boot, 1, quantile, probs = c(0.05, 0.95), na.rm = TRUE)) %>%
      as_tibble() %>%
      mutate(age = centres,
             variable = j)
    
    single_envelope <- bind_rows(single_envelope, envelope)
    
    plot1.1 <- envelope %>%
      ggplot() +
      geom_ribbon(aes(x = age, ymin = `5%`, ymax = `95%`), alpha = 0.5) +
      labs(subtitle = paste(j))
    
    print(plot1.1)
}
```


Para una sola secuencia
```{r}
single_smooth <- data.frame()

for (j in v_variable) {
    
    aux2 <- allmodels_binn %>%
      filter(variable == j) %>%
      dplyr::select(entity, bincentre, anomaly_bin)
    
    aux_matrix <- aux2 %>%
      arrange(entity, bincentre) %>%
      tidyr::pivot_wider(id_cols = bincentre, names_from = entity, values_from = anomaly_bin) %>%
      arrange(bincentre) %>%
      dplyr::select(-bincentre) %>%
      as.matrix()
    
    centres <- unique(aux2$bincentre)
    
    # Loess regression of all sites
    y <- c(aux_matrix)
    x <- rep(centres, ncol(aux_matrix))
    
    aux3 <- as.data.frame(cbind(x, y))
    locboot <- locfit(y ~ lp(x, deg = 1, h = hw), maxk = 2000, family = "grgauss")
    aux_predict <- predict(locboot, newdata = centres, se.fit = TRUE) # loess smoothed fit through all data
    aux_fit <- aux_predict$fit # save output
    
    # Create output data frame
    aux4 <- aux_fit %>%
      as_tibble() %>%
      rename(value_smooth = value) %>%
      mutate(age = centres,
             variable = j)
    
    single_smooth <- bind_rows(single_smooth, aux4)
    
    plot1 <- ggplot(data = aux4, aes(x = age, y = value_smooth)) +
      geom_line() +
      labs(subtitle = paste(j, "-", i))
    
    print(plot1)
}
```



```{r}
saveRDS(smooth_envelope, "plot_groups/3_zones_c_allmodels_envelope.rds")
```



For a single timeseries
```{r}
single_envelope 

single_smooth #|>
 # mutate(model="fxTWA-PLS") |>
 # write.csv("D:/Tercer_paper_clean_version_final/Output_smooth/smooth_fxTWA-PLS.csv")

single_envelope <- single_envelope |>
  inner_join(single_smooth, by = c("age", "variable")) |>
  inner_join(single_mean, by=c("age"="bincentre", "variable")) 

#write.csv(smooth_envelope,"alpha_with_mtco_mtwa.csv")
```


```{r}
single_envelope1 <- single_envelope |> 
  filter(variable != "alpha") |>
  mutate(variable = case_when(variable == "alpha_pred_corr" ~ "alpha_adj",
                              variable == "gdd" ~ "gdd0", TRUE ~ variable)) |>
  mutate(variable = factor(variable, levels = c("mtco", "mtwa","alpha_adj","gdd0")))

plot1 <- single_envelope1 |>
  ggplot(aes(x = age)) +
  geom_ribbon(aes(ymin = `5%`, ymax = `95%`, fill = variable), alpha = 0.3, fill="gray70") +
  geom_step(aes(y = anomaly_mean), colour = "gray58") +
  geom_line(aes(y = value_smooth, colour = variable), colour="#fa3c4c") +
  scale_x_continuous(expand = c(0, 0), breaks = seq(0, 11500, 1000), labels = seq(0, 11.5, 1)) +
  facet_wrap(~variable, scales = "free_y") +
  labs(subtitle = "All fossil entities in latin america", y="Anomaly", x="Age (ky)") +
  theme(strip.background = element_rect(fill="transparent",colour="transparent"),
        strip.text = element_text(hjust = 0, vjust = -0.5,face = "bold"),
        panel.background = element_rect(fill = "transparent", colour = "transparent"),
        panel.border = element_rect(fill = "transparent", colour = "black"))
plot1
```


```{r}
ggsave(plot=plot_groups, "Output_figures/",units = "cm", width = 25, height = 12)
```


```{r}
saveRDS(single_envelope, "plot_groups/3_zones_c_single_envelope.rds")
```







```{r}
plot_single <- single_envelope |>
  filter(variable != "alpha") |>
  ggplot(aes(x=age)) +
  geom_ribbon(aes(ymin=`5%`, ymax=`95%`), fill="gray80", alpha=0.5) +
  geom_step(aes(y=anomaly_mean),colour="#838383") +
  geom_line(aes(y=value_smooth), colour="#4f5dff",size=0.5) +
  scale_x_continuous(breaks = seq(0,12500,2000), labels = seq(0,12.5,2)) +
  facet_wrap(~ variable, scales="free_y") +
  theme(strip.background = element_rect(fill="transparent",colour="transparent"),       # Remove strip background
        strip.text = element_text(hjust = 0, vjust = -0.5,face = "bold"),
        panel.background = element_rect(fill="transparent", colour="transparent"),
        panel.border = element_rect(fill="transparent", colour="black")) +  # Align text to left
  labs(title = "window = 400")

plot_single
```




```{r}
plot_gdd <- single_envelope |>
  filter(variable == "gdd") |>
  ggplot(aes(x=age)) +
  geom_ribbon(aes(ymin=`5%`,ymax=`95%`), alpha = 0.25, fill="gray75") +
  geom_step(aes(y= anomaly_mean), colour="#838383", size=0.35) +
  geom_line(aes(y= value_smooth),size=0.35, colour="#4f5dff") +
  expand_limits(x = c(0, 12500)) +
  scale_x_continuous(breaks = seq(0,12500,1000),labels = seq(0,12.5,1),expand = c(0.03,0.03))+
  scale_y_continuous(n.breaks = 10) +
  labs(x="Age (cal. ky)", y="GDD0", subtitle = "GDD0")+
  theme(legend.title = element_blank(),
        legend.position = c(0.13,0.87),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(size=8),
        legend.key.size = unit(0.26,"cm"),
        legend.spacing.x = unit(0.08,"cm"),
        axis.title = element_text(size=8),
        axis.text = element_text(size=8),
        #axis.title = element_blank(),
        #axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(color="transparent",fill = "transparent"),
        panel.border = element_rect(colour="black",fill="transparent"),
        panel.grid.major.x = element_line(linetype = "dotted", colour = "gray"))

plot_gdd
```



```{r}
plot_mtco <- single_envelope |>
  filter(variable == "mtco") |>
  ggplot(aes(x=age)) +
  geom_ribbon(aes(ymin=`5%`,ymax=`95%`), alpha = 0.25, fill="gray75") +
  geom_step(aes(y= anomaly_mean), colour="#838383", size=0.35) +
  geom_line(aes(y= value_smooth),size=0.35, colour="#4f5dff") +
  expand_limits(x = c(0, 12500)) +
  scale_x_continuous(breaks = seq(0,12500,1000),labels = seq(0,12.5,1),expand = c(0.03,0.03))+
  scale_y_continuous(n.breaks = 10) +
  labs(x="Age (cal. ky)", y="MTCO (°C)", subtitle="MTCO")+
  theme(legend.title = element_blank(),
        legend.position = c(0.13,0.87),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(size=8),
        legend.key.size = unit(0.26,"cm"),
        legend.spacing.x = unit(0.08,"cm"),
        axis.title = element_text(size=8),
        axis.text = element_text(size=8),
        #axis.title = element_blank(),
        #axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(color="transparent",fill = "transparent"),
        panel.border = element_rect(colour="black",fill="transparent"),
        panel.grid.major.x = element_line(linetype = "dotted", colour = "gray"))

plot_mtco
```

```{r}
plot_mtwa <- single_envelope |>
  filter(variable == "mtwa") |>
  ggplot(aes(x=age)) +
  geom_ribbon(aes(ymin=`5%`,ymax=`95%`), alpha = 0.25, fill="gray75") +
  geom_step(aes(y= anomaly_mean), colour="#838383", size=0.35) +
  geom_line(aes(y= value_smooth),size=0.35, colour="#4f5dff") +
  expand_limits(x = c(0, 12500)) +
  scale_x_continuous(breaks = seq(0,12500,1000),labels = seq(0,12.5,1),expand = c(0.03,0.03))+
  scale_y_continuous(n.breaks = 10) +
  labs(x="Age (cal. ky)", y="MTWA (°C)", subtitle="MTWA")+
  theme(legend.title = element_blank(),
        legend.position = c(0.13,0.87),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(size=8),
        legend.key.size = unit(0.26,"cm"),
        legend.spacing.x = unit(0.08,"cm"),
        axis.title = element_text(size=8),
        axis.text = element_text(size=8),
        #axis.title = element_blank(),
        #axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(color="transparent",fill = "transparent"),
        panel.border = element_rect(colour="black",fill="transparent"),
        panel.grid.major.x = element_line(linetype = "dotted", colour = "gray"))

plot_mtwa
```

```{r}
plot_alpha <- single_envelope |>
  filter(variable == "alpha_pred_corr") |>
  ggplot(aes(x=age)) +
  geom_ribbon(aes(ymin=`5%`,ymax=`95%`), alpha = 0.25, fill="gray75") +
  geom_step(aes(y= anomaly_mean), colour="#838383", size=0.35) +
  geom_line(aes(y= value_smooth),size=0.35, colour="#4f5dff") +
  expand_limits(x = c(0, 12500)) +
  scale_x_continuous(breaks = seq(0,12500,1000),labels = seq(0,12.5,1),expand = c(0.03,0.03))+
  scale_y_continuous(n.breaks = 10) +
  labs(x="Age (cal. ky)", y=expression(alpha), subtitle = expression(alpha))+
  theme(legend.title = element_blank(),
        legend.position = c(0.13,0.87),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(size=8),
        legend.key.size = unit(0.26,"cm"),
        legend.spacing.x = unit(0.08,"cm"),
        axis.title = element_text(size=8),
        axis.text = element_text(size=8),
        #axis.title = element_blank(),
        #axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(color="transparent",fill = "transparent"),
        panel.border = element_rect(colour="black",fill="transparent"),
        panel.grid.major.x = element_line(linetype = "dotted", colour = "gray"))

plot_alpha
```

```{r}
ggsave(plot_alpha, filename = "plot_groups/grouping_c_single_Alpha.pdf",units = "cm",width = 7,height = 4.6)
```



```{r}
ggsave(plot_gdd, filename = "plot_groups/grouping_c_single_gdd.pdf",units = "cm",width = 7,height = 4.6)
```



```{r}
ggsave(plot_mtwa, filename = "plot_groups/grouping_c_single_mtwa.pdf",units = "cm",width = 7,height = 4.6)
```


```{r}
ggsave(plot_mtco, filename = "plot_groups/grouping_c_single_mtco.pdf",units = "cm",width = 7,height = 4.6)
```



